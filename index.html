<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ARC v17 CYCLE COUNT</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght=500&display=swap" rel="stylesheet">

    <style>
        /* GENEL ATMOSFER */
        body { background-color: #0b0f19; color: #e2e8f0; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        /* SCROLLBAR GİZLEME */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* KAMERA ALANI */
        #scanner-container { position: fixed; inset: 0; z-index: 50; background: #000; display: none; }
        #reader { width: 100%; height: 100%; }
        #reader video { object-fit: cover !important; width: 100% !important; height: 100% !important; }
        
        /* MODERN MODAL (BOTTOM SHEET STİLİ) */
        .modal-overlay { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(4px);
            z-index: 100; opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        
        .modal-content {
            position: fixed; bottom: 0; left: 0; right: 0; background: #1e293b; 
            border-t-left-radius: 24px; border-t-right-radius: 24px;
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 101; padding: 24px; max-height: 90vh; overflow-y: auto; border-top: 1px solid #334155;
        }
        .modal-overlay.active .modal-content { transform: translateY(0); }

        /* VİZÖR EFEKTLERİ */
        .scan-laser {
            position: absolute; top: 50%; left: 10%; width: 80%; height: 2px;
            background: #38bdf8; box-shadow: 0 0 20px #38bdf8;
            animation: scanLine 2s infinite ease-in-out; z-index: 60;
        }
        @keyframes scanLine { 0% { top: 20%; opacity: 0; } 50% { opacity: 1; } 100% { top: 80%; opacity: 0; } }

        /* KART TASARIMLARI */
        .stat-card {
            background: linear-gradient(145deg, #1e293b 0%, #0f172a 100%);
            border: 1px solid #334155; border-radius: 16px; padding: 20px;
        }
        
        .stock-card {
            background: #172033; border: 1px solid #28354c; border-radius: 16px;
            transition: transform 0.1s; position: relative; overflow: hidden;
        }
        .stock-card:active { transform: scale(0.98); }

        /* FILTER CHIPS */
        .filter-chip {
            padding: 8px 16px; border-radius: 99px; font-size: 12px; font-weight: 600;
            background: #1e293b; border: 1px solid #334155; color: #94a3b8; transition: all 0.2s;
            white-space: nowrap;
        }
        .filter-chip.active { background: #3b82f6; color: white; border-color: #3b82f6; }
        
        /* TIMELINE STYLES */
        .timeline { border-left: 2px solid #334155; padding-left: 1rem; }
        .timeline-item { position: relative; margin-bottom: 1rem; padding-bottom: 1rem; }
        .timeline-item:before {
            content: ''; position: absolute; left: -14px; top: 0;
            width: 10px; height: 10px; border-radius: 50%; background: #475569;
            border: 2px solid #1e293b; 
        }
        .timeline-in:before { background: #10b981; }
        .timeline-out:before { background: #f43f5e; }
        .timeline-transfer:before { background: #facc15; }
        .timeline-count:before { background: #3b82f6; }
    </style>
</head>
<body class="flex flex-col h-full overflow-hidden">

    <header class="h-16 flex items-center justify-between px-6 border-b border-slate-800 bg-[#0b0f19] z-20">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded-lg bg-blue-600 flex items-center justify-center shadow-[0_0_15px_rgba(37,99,235,0.5)]">
                <i class="fas fa-cube text-white text-xs"></i>
            </div>
            <h1 class="font-bold text-lg tracking-tight">ARC <span class="text-blue-500 font-light">v17</span></h1>
        </div>
        <button onclick="toggleSettings()" class="text-slate-400 hover:text-white transition"><i class="fas fa-sliders-h"></i></button>
    </header>

    <main class="flex-1 overflow-y-auto no-scrollbar pb-24 relative">
        
        <div id="page-home" class="p-6 space-y-6 fade-in">
            <div class="grid grid-cols-2 gap-4">
                <button onclick="startScanner('IN')" class="group relative h-24 rounded-2xl bg-gradient-to-br from-emerald-900/50 to-slate-900 border border-emerald-500/30 overflow-hidden active:scale-95 transition-all">
                    <div class="absolute top-3 left-3 p-2 bg-emerald-500/20 rounded-lg text-emerald-400"><i class="fas fa-arrow-down text-sm"></i></div>
                    <div class="absolute bottom-3 left-3 text-left">
                        <div class="text-xl font-bold text-white group-hover:text-emerald-400 transition">GİRİŞ</div>
                    </div>
                </button>

                <button onclick="startScanner('OUT')" class="group relative h-24 rounded-2xl bg-gradient-to-br from-rose-900/50 to-slate-900 border border-rose-500/30 overflow-hidden active:scale-95 transition-all">
                    <div class="absolute top-3 left-3 p-2 bg-rose-500/20 rounded-lg text-rose-400"><i class="fas fa-arrow-up text-sm"></i></div>
                    <div class="absolute bottom-3 left-3 text-left">
                        <div class="text-xl font-bold text-white group-hover:text-rose-400 transition">ÇIKIŞ</div>
                    </div>
                </button>
                
                 <button onclick="startScanner('TRANSFER')" class="group relative h-24 rounded-2xl bg-gradient-to-br from-yellow-900/50 to-slate-900 border border-yellow-500/30 overflow-hidden active:scale-95 transition-all">
                    <div class="absolute top-3 left-3 p-2 bg-yellow-500/20 rounded-lg text-yellow-400"><i class="fas fa-exchange-alt text-sm"></i></div>
                    <div class="absolute bottom-3 left-3 text-left">
                        <div class="text-xl font-bold text-white group-hover:text-yellow-400 transition">TAŞIMA</div>
                    </div>
                </button>
                 <button onclick="startScanner('COUNT')" class="group relative h-24 rounded-2xl bg-gradient-to-br from-blue-900/50 to-slate-900 border border-blue-500/30 overflow-hidden active:scale-95 transition-all">
                    <div class="absolute top-3 left-3 p-2 bg-blue-500/20 rounded-lg text-blue-400"><i class="fas fa-calculator text-sm"></i></div>
                    <div class="absolute bottom-3 left-3 text-left">
                        <div class="text-xl font-bold text-white group-hover:text-blue-400 transition">SAYIM</div>
                    </div>
                </button>
            </div>

            <div>
                <h3 class="text-slate-500 text-xs font-bold uppercase mb-3 px-1">Genel Durum</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div class="stat-card">
                        <div class="text-slate-400 text-[10px] font-bold uppercase mb-1">Toplam Stok</div>
                        <div class="text-3xl font-bold text-white" id="dash-total">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="text-rose-400 text-[10px] font-bold uppercase mb-1">Kritik Seviye</div>
                        <div class="text-3xl font-bold text-white" id="dash-critical">0</div>
                    </div>
                    <div class="stat-card col-span-2 flex justify-between items-center">
                        <div>
                            <div class="text-blue-400 text-[10px] font-bold uppercase">Bugünkü İşlem</div>
                            <div class="text-xl font-bold text-white mt-1" id="dash-today">0 Hareket</div>
                        </div>
                        <div class="h-10 w-10 bg-slate-800 rounded-full flex items-center justify-center text-slate-500">
                            <i class="fas fa-chart-pie"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="storage-status" class="stat-card">
                <div class="flex justify-between items-center">
                    <div class="text-slate-400 text-[10px] font-bold uppercase">Lokal Hafıza Kullanımı</div>
                    <div class="text-xs font-mono text-white" id="storage-kb">0 KB</div>
                </div>
                <div class="w-full bg-slate-700 h-2 rounded-full mt-2">
                    <div id="storage-bar" class="h-2 rounded-full" style="width: 0%"></div>
                </div>
                <div class="text-[10px] mt-1 text-right text-slate-500" id="storage-percentage">0% Kullanıldı</div>
            </div>

            <div class="text-center mt-8">
                <span class="px-3 py-1 bg-slate-800 rounded-full text-[10px] text-slate-500">
                    <i class="fas fa-keyboard mr-1"></i> El Terminali Modu Hazır
                </span>
            </div>
        </div>

        <div id="page-stocks" class="hidden p-6">
            <div class="sticky top-0 bg-[#0b0f19] z-10 pb-4 pt-2 space-y-3">
                <div class="relative">
                    <i class="fas fa-search absolute left-4 top-3.5 text-slate-500 text-sm"></i>
                    <input type="text" id="search-input" onkeyup="renderStocks()" placeholder="Ürün, barkod veya raf..." 
                        class="w-full bg-slate-800/50 border border-slate-700 rounded-xl pl-10 pr-4 py-3 text-sm text-white outline-none focus:border-blue-500 transition">
                </div>
                
                <div class="flex gap-2 overflow-x-auto no-scrollbar pb-1">
                    <button onclick="setFilter('all')" class="filter-chip active" id="filter-all">Tümü</button>
                    <button onclick="setFilter('critical')" class="filter-chip" id="filter-critical">Kritik Stok</button>
                    <button onclick="setFilter('recent')" class="filter-chip" id="filter-recent">Son İşlemler</button>
                </div>
            </div>

            <div id="stock-list" class="space-y-3 pb-20"></div>
        </div>
    </main>

    <nav class="fixed bottom-0 w-full bg-[#0b0f19]/90 backdrop-blur border-t border-slate-800 pb-6 pt-4 px-6 flex justify-around z-30">
        <button onclick="switchPage('home')" class="nav-btn flex flex-col items-center gap-1 text-blue-500 active">
            <i class="fas fa-th-large text-lg"></i>
            <span class="text-[10px] font-medium">Panel</span>
        </button>
        
        <button onclick="startScanner('IN')" class="bg-blue-600 w-12 h-12 rounded-full -mt-8 shadow-lg shadow-blue-600/40 flex items-center justify-center text-white border-4 border-[#0b0f19]">
            <i class="fas fa-qrcode"></i>
        </button>

        <button onclick="switchPage('stocks')" class="nav-btn flex flex-col items-center gap-1 text-slate-500">
            <i class="fas fa-box text-lg"></i>
            <span class="text-[10px] font-medium">Stoklar</span>
        </button>
    </nav>

    <div id="scanner-container">
        <div id="reader"></div>
        <div class="absolute top-0 left-0 w-full p-6 flex justify-between z-[60]">
            <div class="bg-black/40 backdrop-blur-md px-4 py-2 rounded-full border border-white/10">
                <span class="text-xs font-bold text-white tracking-widest" id="scan-mode-text">GİRİŞ MODU</span>
            </div>
            <button onclick="stopScanner()" class="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center text-white backdrop-blur-md"><i class="fas fa-times"></i></button>
        </div>
        
        <div class="scan-laser"></div>
        
        <div class="absolute bottom-10 left-0 w-full flex justify-center z-[60]">
             <label class="flex items-center gap-3 bg-black/50 backdrop-blur px-6 py-3 rounded-full border border-white/10 cursor-pointer">
                <span class="text-xs font-bold text-white">SERİ OKUMA</span>
                <input type="checkbox" id="rapid-mode" class="accent-blue-500 w-5 h-5">
             </label>
        </div>
    </div>

    <div id="product-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="w-12 h-1 bg-slate-700 rounded-full mx-auto mb-6"></div>
            
            <div class="flex gap-4 mb-4">
                <div class="w-20 h-20 bg-slate-800 rounded-xl flex items-center justify-center overflow-hidden border border-slate-700 relative">
                    <img id="m-img" class="w-full h-full object-cover hidden">
                    <i id="m-icon" class="fas fa-box text-slate-600 text-2xl"></i>
                    <label class="absolute inset-0 bg-black/50 opacity-0 hover:opacity-100 flex items-center justify-center cursor-pointer transition">
                        <i class="fas fa-camera text-white"></i>
                        <input type="file" accept="image/*" class="hidden" onchange="handlePhoto(this)">
                    </label>
                </div>
                <div class="flex-1">
                    <div class="text-[10px] text-slate-500 font-bold mb-1">ÜRÜN İSMİ</div>
                    <input type="text" id="m-name" class="w-full bg-slate-800 border-b border-slate-700 pb-2 text-white font-bold outline-none focus:border-blue-500 transition">
                    <div class="flex items-center gap-2 mt-2">
                        <span class="px-2 py-0.5 bg-yellow-900/30 text-yellow-500 text-[10px] rounded border border-yellow-700/30 font-mono" id="m-lot">LOT: ---</span>
                        <span class="px-2 py-0.5 bg-slate-800 text-slate-400 text-[10px] rounded border border-slate-700" id="m-shelf-display">RAF: ---</span>
                    </div>
                </div>
            </div>

            <div class="flex border-b border-slate-700 mb-6">
                <button onclick="showModalTab('details')" id="tab-details" class="flex-1 py-2 text-sm font-semibold border-b-2 border-blue-500 text-white transition">Detaylar</button>
                <button onclick="showModalTab('history')" id="tab-history" class="flex-1 py-2 text-sm font-semibold border-b-2 border-transparent text-slate-500 transition hover:text-white">Geçmiş</button>
            </div>

            <div id="tab-details-content" class="space-y-4">
                 <div id="transfer-step-warning" class="bg-yellow-900/20 border border-yellow-800/50 p-3 rounded-lg text-yellow-300 text-sm hidden">
                     <i class="fas fa-info-circle mr-2"></i> <span id="transfer-message"></span>
                </div>
                
                <div id="count-compare-area" class="bg-slate-800 p-4 rounded-xl border border-blue-600/50 hidden space-y-3">
                    <div class="text-sm font-bold text-blue-400 flex items-center gap-2"><i class="fas fa-list-ol"></i> STOK SAYIMI</div>
                    <div class="grid grid-cols-2 gap-3 text-center">
                         <div>
                            <div class="text-[10px] text-slate-500 uppercase">Sistem Kaydı</div>
                            <div id="count-system-qty" class="text-3xl font-extrabold text-white">0</div>
                         </div>
                         <div>
                            <div class="text-[10px] text-slate-500 uppercase">Sayılan Miktar</div>
                            <input type="number" id="count-input-qty" value="1" min="1" class="w-full text-3xl font-extrabold text-blue-400 bg-slate-900 rounded-lg p-2 text-center outline-none focus:ring-2 ring-blue-500">
                         </div>
                    </div>
                    <div id="count-difference" class="text-center font-bold text-sm pt-2"></div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-slate-800 p-3 rounded-xl border border-slate-700">
                        <div class="text-[10px] text-slate-500">REF / SKU</div>
                        <div class="text-sm font-mono text-white truncate" id="m-ref">---</div>
                    </div>
                    <div class="bg-slate-800 p-3 rounded-xl border border-slate-700">
                        <div class="text-[10px] text-slate-500">SON İŞLEM SN</div>
                        <div class="text-sm font-mono text-white truncate" id="m-sn">---</div>
                    </div>
                    <div class="col-span-2">
                        <label class="text-[10px] text-slate-500 block mb-1 flex justify-between">
                            <span>RAF KONUMU</span>
                            <span id="m-shelf-suggestion" class="text-blue-400 hidden">ÖNERİ: A-10</span>
                        </label>
                        <input type="text" id="m-shelf-input" class="w-full bg-slate-800 rounded-lg p-3 text-white text-sm border border-slate-700 outline-none focus:border-blue-500 uppercase">
                    </div>
                </div>
                <button onclick="saveProduct()" id="m-btn-save" class="w-full py-4 bg-blue-600 rounded-xl font-bold text-white shadow-lg shadow-blue-900/20 active:scale-95 transition">ONAYLA</button>
                <button onclick="logCount()" id="m-btn-count" class="w-full py-4 bg-blue-600 rounded-xl font-bold text-white shadow-lg shadow-blue-900/20 active:scale-95 transition hidden">SAYIMI KAYDET (Veri Değişmez)</button>
            </div>
            
            <div id="tab-history-content" class="hidden">
                 <div id="log-timeline" class="timeline">
                    <p class="text-slate-600 text-sm text-center py-6">Bu ürünün henüz hareketi yok.</p>
                 </div>
            </div>


            <button onclick="closeModal()" class="w-full py-3 mt-6 text-slate-500 text-xs font-bold">KAPAT</button>
        </div>
    </div>

    <div id="settings-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="font-bold text-white text-lg mb-4">Veri Yönetimi</h3>
            <div class="space-y-3">
                <button onclick="exportExcel()" class="w-full p-4 bg-slate-800 rounded-xl flex items-center justify-between text-white border border-slate-700">
                    <div class="flex items-center gap-3"><i class="fas fa-file-excel text-emerald-500"></i> Excel Raporu</div>
                    <i class="fas fa-chevron-right text-slate-600"></i>
                </button>
                <button onclick="resetData()" class="w-full p-4 bg-red-900/20 border border-red-900/50 rounded-xl flex items-center justify-between text-red-400">
                    <div class="flex items-center gap-3"><i class="fas fa-trash"></i> Veritabanını Sil</div>
                </button>
            </div>
            <button onclick="toggleSettings()" class="w-full py-4 mt-6 bg-slate-800 rounded-xl font-bold text-white">Kapat</button>
        </div>
    </div>

    <script>
        // --- CORE LOGIC ---
        const DB_KEY = 'arc_v17_db';
        let db = { products: {} };
        let html5QrCode;
        let scanMode = 'IN'; // IN, OUT, TRANSFER, COUNT
        let parsedData = null;
        let activeFilter = 'all';
        let transferStep = 0; // 0: Hazır, 1: Kaynak Raf Taranıyor, 2: Ürün Taranıyor, 3: Hedef Raf Taranıyor
        let transferSourceProd = null;
        let transferSourceShelf = null;

        function init() {
            try {
                const d = localStorage.getItem(DB_KEY);
                if(d) db = JSON.parse(d);
                updateDashboard();
            } catch(e) { console.error(e); }
        }

        function saveDB() {
            localStorage.setItem(DB_KEY, JSON.stringify(db));
            updateDashboard();
        }

        function playFeedback(type) {
            if (navigator.vibrate) { navigator.vibrate(type === 'error' ? [50,50,50] : 100); }
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator(); const gain = ctx.createGain();
            osc.connect(gain); gain.connect(ctx.destination);
            
            if(type === 'success') { osc.type = 'sine'; osc.frequency.setValueAtTime(800, ctx.currentTime); osc.frequency.exponentialRampToValueAtTime(400, ctx.currentTime + 0.1); } 
            else { osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, ctx.currentTime); }
            
            gain.gain.setValueAtTime(0.1, ctx.currentTime); gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.1);
            osc.start(); osc.stop(ctx.currentTime + 0.1);
        }

        function parseBarcode(text) {
            let res = { raw: text, gtin: "", lot: "NO-LOT", ref: "", sn: "", uniqueId: "" };
            text = text.replace(/\s+/g, ' ').trim();
            
            // Raf/Lokasyon barkodlarını basitçe ayırma
            if(text.length < 15 && !text.includes(' ') && text.match(/[A-Z]{1,3}-\d+/i)) {
                return { isShelf: true, shelf: text.toUpperCase() };
            }
            
            if(text.includes(' ')) { 
                const parts = text.split(' ');
                for(let i=0; i<parts.length; i++) {
                    let k = parts[i], v = parts[i+1];
                    if(!v) continue;
                    if(k=='01') res.gtin=v; if(k=='10') res.lot=v; 
                    if(k=='21') res.sn=v; if(k=='240') res.ref=v;
                }
            } else { res.sn = text; } 
            
            res.uniqueId = (res.ref || res.gtin || "GENERIC") + "_" + res.lot;
            res.isShelf = false;
            return res;
        }

        function startScanner(mode) {
            scanMode = mode;
            document.getElementById('scanner-container').style.display = 'block';
            document.getElementById('rapid-mode').checked = false; 

            const modeText = { 
                'IN': 'GİRİŞ MODU', 
                'OUT': 'ÇIKIŞ MODU', 
                'TRANSFER': 'TAŞIMA MODU (1. Adım: Kaynak Raf)',
                'COUNT': 'STOK SAYIM MODU'
            }[mode];
            document.getElementById('scan-mode-text').innerText = modeText;
            
            const color = { 
                'IN': '#10b981', 
                'OUT': '#f43f5e', 
                'TRANSFER': '#facc15',
                'COUNT': '#3b82f6'
            }[mode];
            document.querySelector('.scan-laser').style.background = color;
            
            // Transfer modunu sıfırla
            transferStep = (mode === 'TRANSFER' ? 1 : 0);
            transferSourceProd = null;
            transferSourceShelf = null;

            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 20, qrbox: 250 }, onScan);
        }

        function stopScanner() {
            if(html5QrCode) html5QrCode.stop().then(() => {
                html5QrCode.clear(); 
                document.getElementById('scanner-container').style.display = 'none';
                transferStep = 0;
            });
        }

        function onScan(decodedText) {
            try {
                parsedData = parseBarcode(decodedText);

                if (parsedData.isShelf) {
                    if (scanMode === 'TRANSFER') {
                        handleTransferScan();
                        return;
                    }
                    // Sayım modunda rafa sayım yapılıyorsa ürün beklenmeli (Şimdilik ignore)
                    playFeedback('error');
                    return;
                }

                // Eğer ürün tarandıysa, transfer modunun 2. veya 3. adımında olabilir
                if (scanMode === 'TRANSFER') {
                    handleTransferScan(); // Bu kısım 2. adımı halledecek
                    return;
                }
                
                const prod = db.products[parsedData.uniqueId];
                const isRapid = document.getElementById('rapid-mode').checked;
                
                if (scanMode === 'COUNT') {
                     if(html5QrCode) html5QrCode.pause();
                     playFeedback('success');
                     openModal(prod);
                     return;
                }

                // Normal IN/OUT Modu (Seri Okuma Kontrolü)
                if(isRapid && prod) {
                    const exists = prod.logs.find(l => l.sn === parsedData.sn && l.type === 'IN'); 
                    
                    if(scanMode === 'IN' && exists) { playFeedback('error'); return; } 
                    if(scanMode === 'OUT' && !exists) { playFeedback('error'); return; } 

                    playFeedback('success');
                    const entry = { sn: parsedData.sn, date: new Date().toISOString(), type: scanMode, shelf: prod.shelf };
                    prod.logs.push(entry);
                    prod.totalQty = scanMode === 'IN' ? prod.totalQty + 1 : Math.max(0, prod.totalQty - 1);
                    prod.lastAction = new Date().getTime();
                    saveDB();
                    return;
                }

                // Normal IN/OUT Modu (Modal)
                if(html5QrCode) html5QrCode.pause();
                playFeedback('success');
                openModal(prod);

            } catch(e) {
                console.error(e);
                if(html5QrCode) html5QrCode.resume();
            }
        }

        // --- YENİ ÖZELLİK: SAYIM MODU İŞLEMLERİ ---
        function updateCountComparison(systemQty) {
            const countInput = document.getElementById('count-input-qty');
            const differenceDiv = document.getElementById('count-difference');
            
            const countedQty = parseInt(countInput.value) || 0;
            const diff = countedQty - systemQty;
            
            if (diff === 0) {
                differenceDiv.innerText = "FARK YOK. Sayım BAŞARILI.";
                differenceDiv.className = "text-center font-bold text-sm pt-2 text-emerald-400";
            } else if (diff > 0) {
                differenceDiv.innerText = `+${diff} adet FAZLA`;
                differenceDiv.className = "text-center font-bold text-sm pt-2 text-rose-400";
            } else {
                differenceDiv.innerText = `${diff} adet EKSİK`;
                differenceDiv.className = "text-center font-bold text-sm pt-2 text-rose-400";
            }
        }

        function logCount() {
            const systemQty = parseInt(document.getElementById('count-system-qty').innerText) || 0;
            const countedQty = parseInt(document.getElementById('count-input-qty').value) || 0;
            const shelf = document.getElementById('m-shelf-input').value.toUpperCase();

            // Sayım işlemi stok miktarını DEĞİŞTİRMEZ, sadece log kaydı oluşturur.
            
            if(!db.products[parsedData.uniqueId]) {
                 // Eğer ürün hiç kaydedilmemişse, yeni bir kayıt oluşturup logluyoruz (Sisteme kayıt 0 olacak)
                 db.products[parsedData.uniqueId] = {
                    id: parsedData.uniqueId, name: document.getElementById('m-name').value || "Yeni Ürün", ref: parsedData.ref || parsedData.gtin, lot: parsedData.lot,
                    shelf: shelf, totalQty: 0, logs: [], image: null, lastAction: Date.now()
                };
            }
            
            const prod = db.products[parsedData.uniqueId];
            
            const entry = { 
                date: new Date().toISOString(), 
                type: 'COUNT', 
                systemQty: systemQty,
                countedQty: countedQty,
                shelf: shelf
            };
            
            prod.logs.push(entry);
            prod.lastAction = Date.now(); // Son işlem tarihini güncelle

            saveDB();
            closeModal();
            stopScanner();
        }

        // --- TRANSFER YÖNETİMİ (Kısaltılmış) ---
        function handleTransferScan() {
            // ... (V16'daki transfer mantığı buraya gelir)
            const scanDisplay = document.getElementById('scan-mode-text');

            if (transferStep === 1) { // Kaynak Raf Taranıyor
                if (!parsedData.isShelf) { 
                    playFeedback('error'); scanDisplay.innerText = "HATA: Kaynak RAF barkodunu tarayın!";
                    setTimeout(() => scanDisplay.innerText = "TAŞIMA MODU (1. Adım: Kaynak Raf)", 2000); return;
                }
                transferSourceShelf = parsedData.shelf;
                transferStep = 2;
                scanDisplay.innerText = `TAŞIMA MODU (2. Adım: Ürün. Kaynak: ${transferSourceShelf})`; playFeedback('success');
            
            } else if (transferStep === 2) { // Ürün Taranıyor
                if (parsedData.isShelf) {
                    playFeedback('error'); scanDisplay.innerText = "HATA: ÜRÜN barkodunu tarayın!";
                    setTimeout(() => scanDisplay.innerText = `TAŞIMA MODU (2. Adım: Ürün. Kaynak: ${transferSourceShelf})`, 2000); return;
                }
                transferSourceProd = db.products[parsedData.uniqueId];
                
                if (!transferSourceProd || transferSourceProd.totalQty === 0) {
                    playFeedback('error'); scanDisplay.innerText = "HATA: Stokta Ürün Bulunamadı!";
                    transferStep = 1; transferSourceShelf = null;
                    setTimeout(() => scanDisplay.innerText = 'TAŞIMA MODU (1. Adım: Kaynak Raf)', 3000); return;
                }

                if (transferSourceProd.shelf !== transferSourceShelf) {
                    scanDisplay.innerText = `UYARI: Ürünün rafı ${transferSourceProd.shelf}. Hedef Rafı tarayın.`;
                }
                transferStep = 3;
                scanDisplay.innerText = `TAŞIMA MODU (3. Adım: Hedef Raf)`; playFeedback('success');

            } else if (transferStep === 3) { // Hedef Raf Taranıyor
                if (!parsedData.isShelf) { 
                    playFeedback('error'); scanDisplay.innerText = "HATA: HEDEF RAF barkodunu tarayın!";
                    setTimeout(() => scanDisplay.innerText = `TAŞIMA MODU (3. Adım: Hedef Raf)`, 2000); return;
                }
                const targetShelf = parsedData.shelf;

                // Transferi Gerçekleştir ve Logla
                transferSourceProd.shelf = targetShelf;
                transferSourceProd.lastAction = Date.now();
                
                const entry = { date: new Date().toISOString(), type: 'TRANSFER', sourceShelf: transferSourceShelf, targetShelf: targetShelf };
                transferSourceProd.logs.push(entry);
                
                saveDB();
                playFeedback('success');
                scanDisplay.innerText = `BAŞARILI: ${transferSourceProd.name} ${transferSourceShelf} -> ${targetShelf}`;
                
                transferStep = 1; 
                transferSourceProd = null;
                transferSourceShelf = null;
                setTimeout(() => scanDisplay.innerText = 'TAŞIMA MODU (1. Adım: Kaynak Raf)', 3000);
            }
        }
        
        // --- MODAL YÖNETİMİ ---
        function openModal(prod) {
            const m = document.getElementById('product-modal');
            const data = parsedData;

            // UI Görünürlüğünü Ayarla
            const isCountMode = scanMode === 'COUNT';
            document.getElementById('m-btn-save').classList.toggle('hidden', isCountMode);
            document.getElementById('m-btn-count').classList.toggle('hidden', !isCountMode);
            document.getElementById('count-compare-area').classList.toggle('hidden', !isCountMode);

            // Verileri Yükle
            document.getElementById('m-lot').innerText = "LOT: " + (prod ? prod.lot : data.lot);
            document.getElementById('m-ref').innerText = prod ? prod.ref : (data.ref || "---");
            document.getElementById('m-sn').innerText = data.sn || "---";
            document.getElementById('m-name').value = prod ? prod.name : "";
            
            const currentShelf = (prod ? prod.shelf : "") || "";
            document.getElementById('m-shelf-input').value = currentShelf;
            document.getElementById('m-shelf-display').innerText = "RAF: " + (currentShelf || "---");

            // COUNT Moduna Özel Veriler
            if (isCountMode) {
                const systemQty = prod ? prod.totalQty : 0;
                document.getElementById('count-system-qty').innerText = systemQty;
                document.getElementById('count-input-qty').value = systemQty > 0 ? systemQty : 1; // Başlangıç değeri
                
                // Karşılaştırma fonksiyonunu Input değiştiğinde çağır
                document.getElementById('count-input-qty').oninput = () => updateCountComparison(systemQty);
                updateCountComparison(systemQty);
                
                // Sayım modunda raf değiştirilebilir olmalı
                document.getElementById('m-shelf-input').disabled = false;
            } else {
                 document.getElementById('m-shelf-input').disabled = false;
            }

            // Görsel Yükle
            const img = document.getElementById('m-img');
            const icon = document.getElementById('m-icon');
            if(prod && prod.image) { img.src = prod.image; img.classList.remove('hidden'); icon.classList.add('hidden'); }
            else { img.classList.add('hidden'); icon.classList.remove('hidden'); }

            // Log Geçmişini Yükle
            loadProductHistory(prod);
            showModalTab('details');

            m.classList.add('active');
        }

        function loadProductHistory(prod) {
            const timeline = document.getElementById('log-timeline');
            timeline.innerHTML = '';

            if (!prod || prod.logs.length === 0) {
                 timeline.innerHTML = '<p class="text-slate-600 text-sm text-center py-6">Bu ürünün henüz hareketi yok.</p>';
                 return;
            }

            const sortedLogs = [...prod.logs].sort((a, b) => new Date(b.date) - new Date(a.date));

            sortedLogs.forEach(log => {
                let typeClass, icon, description;
                const date = new Date(log.date).toLocaleString('tr-TR');

                if (log.type === 'IN') {
                    typeClass = 'timeline-in';
                    icon = '<i class="fas fa-arrow-down text-emerald-400"></i>';
                    description = `Giriş Yapıldı (Raf: ${log.shelf}) - SN: ${log.sn || 'Yok'}`;
                } else if (log.type === 'OUT') {
                    typeClass = 'timeline-out';
                    icon = '<i class="fas fa-arrow-up text-rose-400"></i>';
                    description = `Çıkış Yapıldı (Raf: ${log.shelf}) - SN: ${log.sn || 'Yok'}`;
                } else if (log.type === 'TRANSFER') {
                    typeClass = 'timeline-transfer';
                    icon = '<i class="fas fa-exchange-alt text-yellow-400"></i>';
                    description = `Taşıma: ${log.sourceShelf} -> ${log.targetShelf}`;
                } else if (log.type === 'COUNT') { // YENİ COUNT LOGU
                    typeClass = 'timeline-count';
                    icon = '<i class="fas fa-list-ol text-blue-400"></i>';
                    const diff = log.countedQty - log.systemQty;
                    let diffText = diff === 0 ? 'Fark Yok' : (diff > 0 ? `+${diff}` : `${diff}`);
                    description = `SAYIM (Raf: ${log.shelf}) - Sistem: ${log.systemQty}, Sayılan: ${log.countedQty} (${diffText})`;
                }

                timeline.innerHTML += `
                    <div class="timeline-item ${typeClass}">
                        <div class="text-[10px] text-slate-500 font-mono">${date}</div>
                        <div class="text-sm font-semibold text-white mt-0.5 flex items-center gap-2">${icon} ${description}</div>
                    </div>
                `;
            });
        }
        
        function showModalTab(tab) {
            document.getElementById('m-btn-save').classList.toggle('hidden', scanMode === 'COUNT' || tab === 'history');
            document.getElementById('m-btn-count').classList.toggle('hidden', scanMode !== 'COUNT' || tab === 'history');
            
            document.getElementById('tab-details-content').classList.add('hidden');
            document.getElementById('tab-history-content').classList.add('hidden');
            document.getElementById('tab-details').classList.remove('border-blue-500', 'text-white');
            document.getElementById('tab-history').classList.remove('border-blue-500', 'text-white');
            document.getElementById('tab-details').classList.add('border-transparent', 'text-slate-500');
            document.getElementById('tab-history').classList.add('border-transparent', 'text-slate-500');

            document.getElementById(`tab-${tab}-content`).classList.remove('hidden');
            document.getElementById(`tab-${tab}`).classList.add('border-blue-500', 'text-white');
            document.getElementById(`tab-${tab}`).classList.remove('border-transparent', 'text-slate-500');
        }

        function closeModal() {
            document.getElementById('product-modal').classList.remove('active');
            if(html5QrCode) html5QrCode.resume();
        }

        function saveProduct() {
            // IN/OUT kaydı (eski mantık)
            if(scanMode === 'COUNT') { logCount(); return; } // Hata yakalama
            
            const name = document.getElementById('m-name').value || "İsimsiz Ürün";
            const shelf = document.getElementById('m-shelf-input').value.toUpperCase();
            
            if(!db.products[parsedData.uniqueId]) {
                db.products[parsedData.uniqueId] = {
                    id: parsedData.uniqueId, name: name, ref: parsedData.ref || parsedData.gtin, lot: parsedData.lot,
                    shelf: shelf, totalQty: 0, logs: [], image: null, lastAction: Date.now()
                };
            }
            
            const prod = db.products[parsedData.uniqueId];
            prod.name = name; 
            prod.shelf = shelf; 

            const imgEl = document.getElementById('m-img');
            if(!imgEl.classList.contains('hidden')) prod.image = imgEl.src;

            const entry = { sn: parsedData.sn, date: new Date().toISOString(), type: scanMode, shelf: shelf };
            const existingLog = prod.logs.find(l => l.sn === parsedData.sn && l.type === 'IN');
            
            if (scanMode === 'IN' && !existingLog) {
                 prod.logs.push(entry);
                 prod.totalQty++;
            } else if (scanMode === 'OUT' && existingLog) {
                 prod.logs.push(entry); 
                 prod.totalQty = Math.max(0, prod.totalQty - 1);
            }
            
            prod.lastAction = Date.now();

            saveDB();
            closeModal();
            stopScanner();
        }
        
        // ... Diğer yardımcı fonksiyonlar (handlePhoto, calculateStorageUsage, updateDashboard, renderStocks, switchPage, toggleSettings, resetData, exportExcel) V16 ile aynıdır.
        // Kodu kısa tutmak için burada tekrar edilmedi, ancak V16'dan kopyalanıp yapıştırıldığını varsayın.

        // --- UI & DASHBOARD (Önemli kısımlar tekrarlandı) ---
        function updateDashboard() {
            const prods = Object.values(db.products);
            const totalStock = prods.reduce((acc, p) => acc + p.totalQty, 0);
            const criticals = prods.filter(p => p.totalQty <= 3 && p.totalQty > 0).length;
            const oneDay = 24 * 60 * 60 * 1000;
            const now = Date.now();
            let todayMoves = 0;
            prods.forEach(p => {
                p.logs.forEach(l => {
                    if(now - new Date(l.date).getTime() < oneDay) todayMoves++;
                });
            });

            document.getElementById('dash-total').innerText = totalStock;
            document.getElementById('dash-critical').innerText = criticals;
            document.getElementById('dash-today').innerText = todayMoves + " Hareket";

            const storage = { kb: 0, percentage: 0 }; // Yer tutucu
            // const storage = calculateStorageUsage();
            
            // UI güncellemeleri...
            
            renderStocks();
        }

        function renderStocks() {
            // ... (V16'daki stok listeleme mantığı buraya gelir)
            const grid = document.getElementById('stock-list');
            const term = document.getElementById('search-input').value.toLowerCase();
            let arr = Object.values(db.products);

            arr = arr.filter(p => 
                p.name.toLowerCase().includes(term) || 
                p.lot.toLowerCase().includes(term) ||
                (p.ref && p.ref.toLowerCase().includes(term)) ||
                (p.shelf && p.shelf.toLowerCase().includes(term))
            );

            if(activeFilter === 'critical') arr = arr.filter(p => p.totalQty <= 3 && p.totalQty > 0);
            if(activeFilter === 'recent') arr = arr.sort((a,b) => b.lastAction - a.lastAction);

            grid.innerHTML = arr.map(p => `
                <div class="stock-card p-4 flex gap-4 items-center" onclick="showProductDetails('${p.id}')">
                    <div class="w-12 h-12 bg-slate-800 rounded-lg flex-none overflow-hidden relative">
                         ${p.image ? `<img src="${p.image}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center text-slate-600"><i class="fas fa-box"></i></div>`}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-start">
                            <h4 class="font-bold text-white text-sm truncate pr-2">${p.name}</h4>
                            <span class="text-[10px] bg-slate-800 px-1.5 py-0.5 rounded text-slate-400 font-mono">${p.shelf || 'NO-RAF'}</span>
                        </div>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="text-[10px] text-yellow-500 bg-yellow-900/20 px-1.5 rounded border border-yellow-900/30">L: ${p.lot}</span>
                            <span class="text-[10px] text-slate-500">REF: ${p.ref}</span>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-xl font-bold ${p.totalQty < 3 ? 'text-red-500' : 'text-blue-400'}">${p.totalQty}</div>
                        <div class="text-[9px] text-slate-500">ADET</div>
                    </div>
                </div>
            `).join('');
            
            if(arr.length === 0) grid.innerHTML = '<div class="text-center text-slate-600 text-xs py-10">Kayıt bulunamadı</div>';
        }

        function showProductDetails(uniqueId) {
             const prod = db.products[uniqueId];
             scanMode = 'IN'; 
             parsedData = { uniqueId: prod.id, lot: prod.lot, ref: prod.ref };
             openModal(prod);
             
             document.getElementById('m-btn-save').classList.add('hidden');
             document.getElementById('m-btn-count').classList.add('hidden');
             document.getElementById('m-shelf-input').disabled = true;
             document.getElementById('count-compare-area').classList.add('hidden');

             showModalTab('history');
        }


        init();
    </script>
</body>
</html>
